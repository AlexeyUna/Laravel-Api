# API для бронирования слотов

Это API для управления бронированием слотов (например, для складских окон, времени доставки или записи на прием). Сервис спроектирован для работы под нагрузкой и включает в себя:

-   **Защиту от оверсела (overselling):** Использование транзакций и пессимистических блокировок на уровне базы данных гарантирует, что количество броней никогда не превысит доступную вместимость слота.
-   **Идемпотентные запросы:** Повторная отправка запроса на создание брони с тем же ключом идемпотентности не приведет к созданию дубликата.
-   **Временные удержания (holds):** Пользователи могут создать временную бронь на 5 минут, которую затем нужно подтвердить.
-   **Горячий кеш:** Для ускорения получения данных о доступных слотах предусмотрена инвалидация кеша при изменении количества мест.

## Требования
-   Laravel 12 (PHP 8.2+) и MySQL 8+
-   **Redis** (для кеширования и очередей)
-   Веб-сервер (Nginx, Apache) или можно использовать встроенный сервер Laravel

## Установка и запуск

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <your-repository-url>
    cd api-app
    ```

2.  **Установите зависимости:**
    ```bash
    composer install
    ```

3.  **Создайте файл `.env`:**
    ```bash
    cp .env.example .env
    ```

4.  **Сгенерируйте ключ приложения:**
    ```bash
    php artisan key:generate
    ```

5.  **Настройте подключение к базе данных** в файле `.env`.

6.  **Настройте подключение к Redis** в файле `.env`. Укажите драйвер кеша и очередей как `redis`.
    ```dotenv
    CACHE_DRIVER=redis
    QUEUE_CONNECTION=redis
    REDIS_HOST=127.0.0.1
    REDIS_PASSWORD=null
    REDIS_PORT=6379
    ```

7.  **Выполните миграции и создайте тестовые данные:**
    ```bash
    php artisan migrate --seed
    ```
    *Эта команда создаст необходимые таблицы в базе данных и заполнит их тестовыми слотами.*

8.  **Запустите сервер:**
    ```bash
    php artisan serve
    ```

## Тестирование основных сценариев

Для тестирования можно использовать любой HTTP-клиент, например, `curl`. Примеры ниже предполагают, что сервер запущен по адресу `http://127.0.0.1:8000`.

### 1. Получение доступных слотов

Чтобы получить список доступных слотов, выполните GET-запрос. Команда `php artisan migrate --seed` создает тестовые слоты на ближайшие дни.

```bash
curl -X GET "http://127.0.0.1:8000/api/slots/availability"
```

В ответе вы получите JSON-список слотов. Запомните `slot_id` одного из слотов для следующего шага. Обратите внимание, что ресурс `SlotResource` не включает поле `datetime`.
```json
{
    "data": [
        {
            "slot_id": 1,
            "capacity": 10,
            "remaining": 10
        }
    ],
    "meta": {
        "count": 1,
        "cursor": 0,
        "next_cursor": null
    }
}
```

### 2. Создание временной брони (hold)

Для создания временной брони выполните POST-запрос, указав `id` слота из предыдущего шага. Вам также понадобится сгенерировать уникальный ключ идемпотентности (рекомендуется UUID).

**Замените `{slot_id}` на реальный ID слота.**

```bash
curl -X POST http://127.0.0.1:8000/api/slots/$SLOT_ID/hold \
-H "Content-Type: application/json" \
-d "{
    \"idempotency_key\": \"$idempotency_key\"
}"
```

В случае успеха вы получите `HTTP 201 Created` и информацию о созданном удержании. Запомните `id` (ключ идемпотентности) удержания (`$HOLD_ID`).
```json
{
    "data": {
        "id": 1,
        "slot_id": 1,
        "status": "held",
        "expires_at": "2025-12-07T12:05:00.000000Z",
        "created_at": "2025-12-07T12:00:00.000000Z",
        "updated_at": "2025-12-07T12:00:00.000000Z"
    }
}
```

### 3. Подтверждение брони

В течение 5 минут после создания временную бронь можно подтвердить. Для этого выполните POST-запрос, указав `id` из ответа создания брони в URL.

**Замените `$HOLD_ID` на id.**

```bash
curl -X POST http://127.0.0.1:8000/api/holds/$HOLD_ID/confirm
```

В случае успеха вы получите `HTTP 200 OK` и данные о подтвержденной брони.

```json
{
    "data": {
        "id": 1,
        "slot_id": 1,
        "status": "confirmed",
        "created_at": "2025-12-07T17:14:08.000000Z",
        "updated_at": "2025-12-07T17:14:46.000000Z"
    }
}
```

Если теперь снова запросить доступные слоты (шаг 1), вы увидите, что `remaining` у этого слота уменьшилось.
При повторном запросе confirm - ответ должен быть тем же. 

### 4. Отмена брони

Бронь можно отменить в любом статусе (`held` или `confirmed`). Для этого выполните DELETE-запрос, указав `id` удержания hold в URL.

**Замените `$HOLD_ID` на id брони.**

```bash
curl -X DELETE http://127.0.0.1:8000/api/holds/$HOLD_ID
```

В случае успеха вы получите `HTTP 200 OK` и данные об отмененной брони (как HoldResource).

```json
{
    "data": {
        "id": 1,
        "slot_id": 1,
        "status": "cancelled",
        "created_at": "2025-12-07T12:00:00.000000Z",
        "updated_at": "2025-12-07T12:02:00.000000Z"
    }
}
```
Если бронь была подтверждена, то после отмены количество свободных мест в слоте (`remaining`) снова увеличится.
